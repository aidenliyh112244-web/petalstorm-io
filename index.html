<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PetalStorm.io v7 â€“ Loot ONLY on Kill + 100x HP + Mini-Map + More Mobs</title>
    <style>
        body { margin:0; background:#111; font-family:Arial; color:#fff; overflow:hidden; }
        canvas { display:block; margin:20px auto; border:4px solid #333; box-shadow:0 0 40px #0f0; }
        #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.75); padding:12px 16px; border-radius:10px; font-size:15px; line-height:1.35; }
        #petalsList { position:absolute; top:10px; right:220px; background:rgba(0,0,0,0.75); padding:10px; border-radius:8px; max-width:260px; font-size:13px; }
        #craftMenu { display:none; position:absolute; bottom:20px; left:20px; background:rgba(15,25,35,0.97); padding:18px; border-radius:16px; border:6px solid #0ff; width:380px; text-align:left; box-shadow:0 0 60px #0ff; }
        #pediaMenu { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(15,25,35,0.97); padding:25px; border-radius:18px; border:6px solid #0ff; width:460px; text-align:center; box-shadow:0 0 60px #0ff; }
        button { background:#0f0; color:#000; font-weight:bold; padding:10px 20px; margin:6px 4px; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
        button:hover { background:#4f4; }
        .group { margin:8px 0; padding:8px; background:#0004; border-radius:8px; }
    </style>
</head>
<body>
    <canvas id="c" width="1000" height="700"></canvas>
    <div id="ui">Score: <span id="score">0</span> | Kills: <span id="kills">0</span><br>
        Level <span id="level">1</span> XP <span id="xp">0</span>/<span id="nextxp">920</span><br>
        Health <span id="health">300</span>/<span id="maxhealth">300</span> Slots <span id="slots">5/5</span><br>
        Zone: <span id="zone">Normal</span>
    </div>
    <div id="petalsList"></div>

    <div id="craftMenu">
        <h2 style="color:#0ff;margin:0 0 12px 0">ðŸŒŸ CRAFTING LAB (Florr.io style)</h2>
        <div id="craftInfo" style="max-height:320px;overflow:auto;"></div>
        <button onclick="closeCraft()" style="background:#555;width:100%;margin-top:12px">Close (ESC)</button>
    </div>

    <div id="pediaMenu">
        <h2 style="color:#0ff">ðŸ“– PEDIA</h2>
        <div id="pediaContent" style="text-align:left;font-size:13px;line-height:1.5;max-height:420px;overflow:auto;"></div>
        <button onclick="closePedia()" style="background:#555">Close (H)</button>
    </div>

    <div id="instructions" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 20px;border-radius:8px;font-size:14px;">
        MOUSE = move â€¢ C = Craft â€¢ H = Pedia â€¢ Loot ONLY on kill â€¢ Mini-map top right
    </div>

<script>
// ====================== PETALSTORM.IO v7 â€“ Loot ONLY on Kill + 100x HP + MiniMap ======================
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 1000, H = 700;

let mouseX = W/2, mouseY = H/2;
canvas.addEventListener('mousemove', e => { const r=canvas.getBoundingClientRect(); mouseX=e.clientX-r.left; mouseY=e.clientY-r.top; });

let keys = {};
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === 'c' || e.key === 'C') toggleCraft();
    if (e.key === 'h' || e.key === 'H') togglePedia();
    if (e.key === 'Escape') { closeCraft(); closePedia(); }
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

const RARITIES = [
    {name:"Common", color:"#aaa", mult:1, chance:40, index:0},
    {name:"Uncommon", color:"#4f4", mult:3, chance:24, index:1},
    {name:"Rare", color:"#48f", mult:9, chance:15, index:2},
    {name:"Epic", color:"#a4f", mult:27, chance:9, index:3},
    {name:"Legendary", color:"#fa2", mult:81, chance:5.5, index:4},
    {name:"Mythic", color:"#f4c", mult:243, chance:3.5, index:5},
    {name:"Ultra", color:"#2ff", mult:729, chance:1.8, index:6},
    {name:"Super", color:"#ff4", mult:2187, chance:0.9, index:7},
    {name:"Eternal", color:"#f55", mult:6561, chance:0.4, index:8},
    {name:"Unique", color:"#4fa", mult:19683, chance:0.2, index:9},
    {name:"Divine", color:"#fd7", mult:59049, chance:0.08, index:10},
    {name:"Cosmic", color:"#7af", mult:177147, chance:0.02, index:11}
];

function getRandomRarity() {
    let r = Math.random()*100, cum=0;
    for (let rar of RARITIES) { cum += rar.chance; if (r < cum) return rar; }
    return RARITIES[0];
}

const MOB_RARITIES = [
    {name:"Normal", mult:1, glow:"#fff", index:0},
    {name:"Rare", mult:5, glow:"#48f", index:1},
    {name:"Epic", mult:25, glow:"#a4f", index:2},
    {name:"Ultra", mult:125, glow:"#fa2", index:3},
    {name:"Nightmare", mult:625, glow:"#f4c", index:4}
];

function getRandomMobRarity(zoneIdx) {
    let target = Math.max(0, Math.min(4, zoneIdx + Math.floor(Math.random()*3)-1));
    return MOB_RARITIES.find(m => m.index === target) || MOB_RARITIES[0];
}

const PETAL_DEFS = {
    basic:  {name:"Basic",  col:"#ddd", dmg:1.0, dur:140, rot:1.0, special:"none"},
    rose:   {name:"Rose",   col:"#f68", dmg:0.35, dur:110, rot:1.0, special:"heal", healRate:1.8},
    stinger:{name:"Stinger",col:"#fc4", dmg:6.2, dur:42, rot:0.8, special:"poison", poison:2.4},
    cactus: {name:"Cactus", col:"#4b4", dmg:1.1, dur:280, rot:0.9, special:"maxhp", bonus:65},
    leaf:   {name:"Leaf",   col:"#8f4", dmg:0.6, dur:160, rot:1.2, special:"heal", healRate:3.1},
    heavy:  {name:"Heavy",  col:"#777", dmg:5.5, dur:310, rot:0.5, special:"knock"},
    shell:  {name:"Shell",  col:"#9cf", dmg:0.95, dur:480, rot:1.0, special:"shield", shield:0.22},
    light:  {name:"Light",  col:"#ff8", dmg:0.8, dur:68, rot:3.4, special:"none"}
};

let player = {x:2000, y:1500, health:300, maxHealth:300, speed:4.3, angle:0, petals:[], level:1, xp:0, xpToNext:920, maxSlots:5, bodyDamage:7, size:26};

let enemies = [], loots = [], walls = [], score = 0, kills = 0, gameOver = false;
let cameraX = 0, cameraY = 0;
let craftOpen = false, pediaOpen = false;

const ENEMY_TYPES = [ // +4 NEW MOBS
    {id:"ladybug", col:"#f66", baseSize:19, baseHP:72, baseSpeed:1.1, baseDmg:0.8, drops:["rose","leaf","basic"]},
    {id:"bee",     col:"#ff4", baseSize:17, baseHP:58, baseSpeed:1.5, baseDmg:1.1, drops:["stinger","light","basic"]},
    {id:"ant",     col:"#c93", baseSize:18, baseHP:52, baseSpeed:1.3, baseDmg:0.9, drops:["basic","light","rose"]},
    {id:"beetle",  col:"#642", baseSize:26, baseHP:165,baseSpeed:0.8, baseDmg:1.5, drops:["cactus","heavy","shell"]},
    {id:"hornet",  col:"#f82", baseSize:22, baseHP:105,baseSpeed:1.4, baseDmg:1.3, drops:["stinger","light"]},
    // NEW MOBS
    {id:"rock",    col:"#888", baseSize:28, baseHP:220,baseSpeed:0.0, baseDmg:2.0, drops:["heavy","rock"]}, // stationary
    {id:"spider",  col:"#822", baseSize:21, baseHP:95, baseSpeed:2.4, baseDmg:1.4, drops:["web","faster"]},
    {id:"scorpion",col:"#c60", baseSize:24, baseHP:130,baseSpeed:1.2, baseDmg:1.8, drops:["iris","pincer"]},
    {id:"bumble",  col:"#fa4", baseSize:19, baseHP:80, baseSpeed:2.8, baseDmg:1.0, drops:["pollen","honey"]}
];

walls = [ /* same walls as v6 */ 
    {x:1400,y:1200,w:600,h:40},{x:1400,y:1800,w:600,h:40},
    {x:1200,y:1400,w:40,h:600},{x:1900,y:1400,w:40,h:600},
    {x:2500,y:900,w:300,h:40},{x:2800,y:2200,w:40,h:400}
];

// PERSISTENCE (same as v6)
function loadProgress() { /* ... same ... */ }
function saveProgress() { /* ... same ... */ }

function updatePlayerStats() { /* same */ }
function getZoneInfo() { /* same */ }

function spawnEnemy() {
    const type = ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
    const zoneIdx = getZoneInfo();
    const mobR = getRandomMobRarity(zoneIdx);
    const ang = Math.random()*Math.PI*2;
    const dist = 480 + Math.random()*720;
    const hp = type.baseHP * 100 * Math.pow(5, mobR.index); // 100x + *5 per rarity
    const dmg = type.baseDmg * Math.pow(5, mobR.index);
    enemies.push({
        ...type,
        rarity: mobR,
        x: player.x + Math.cos(ang)*dist,
        y: player.y + Math.sin(ang)*dist,
        health: hp, maxHealth: hp,
        speed: type.baseSpeed * (1 + mobR.index * 0.3),
        dmg: dmg,
        size: type.baseSize * (1 + mobR.index * 0.25),
        poisonTime:0, poisonDmg:0
    });
}

function spawnLoot(x, y, forcedType = null) { /* only called on kill */ 
    const typeKey = forcedType || Object.keys(PETAL_DEFS)[Math.floor(Math.random()*Object.keys(PETAL_DEFS).length)];
    loots.push({x, y, typeKey, rarity: getRandomRarity()});
}

function collectLoot(i) { /* same */ }

function recalcBonuses() { /* same */ }

// drawPetal (same unique shapes)

// Crafting (same as v6)

// ====================== MINI-MAP ======================
function drawMiniMap() {
    const mx = W - 210, my = 20, ms = 190;
    const worldSize = 8000;
    const sc = ms / worldSize;

    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(mx, my, ms, ms);
    ctx.strokeStyle = '#555';
    ctx.strokeRect(mx, my, ms, ms);

    // player
    const px = mx + (player.x + 4000) * sc;
    const py = my + (player.y + 4000) * sc;
    ctx.fillStyle = '#ffeb3b';
    ctx.beginPath(); ctx.arc(px, py, 5, 0, Math.PI*2); ctx.fill();

    // enemies
    for (let e of enemies) {
        const ex = mx + (e.x + 4000) * sc;
        const ey = my + (e.y + 4000) * sc;
        ctx.fillStyle = e.rarity.glow;
        ctx.beginPath(); ctx.arc(ex, ey, 3, 0, Math.PI*2); ctx.fill();
    }

    // walls (simplified)
    ctx.fillStyle = '#777';
    for (let w of walls) {
        ctx.fillRect(mx + (w.x + 4000)*sc, my + (w.y + 4000)*sc, w.w*sc, w.h*sc);
    }
}

// ====================== MAIN UPDATE & DRAW ======================
function update() {
    if (gameOver) return;

    // movement + walls (same)
    // healing, level up (same)

    // enemies (same + health bars in draw)

    for (let i=enemies.length-1; i>=0; i--) {
        const e = enemies[i];
        // movement, collision, damage (same but with *5 rarity already in spawn)

        let totalDmg = 0;
        for (let j=0; j<player.petals.length; j++) {
            const p = player.petals[j];
            const def = PETAL_DEFS[p.key];
            const pang = player.angle + (j/player.petals.length)*Math.PI*2;
            const px = player.x + Math.cos(pang)*49;
            const py = player.y + Math.sin(pang)*49;
            if (Math.hypot(px-e.x, py-e.y) < 28) {
                totalDmg += def.dmg * Math.pow(p.rarity.mult, 3) * 0.5; // petals *3 per rarity
                p.curDur -= 0.95;
                // poison/knock same
            }
        }
        e.health -= totalDmg;
        // poison tick same

        if (e.health <= 0) {
            // LOOT ONLY ON KILL
            const dropCount = 8 + Math.floor(Math.random()*13) * (1 + e.rarity.index*2);
            for (let d=0; d<dropCount; d++) {
                const forced = Math.random()<0.82 ? e.drops[Math.floor(Math.random()*e.drops.length)] : null;
                spawnLoot(e.x+(Math.random()-0.5)*60, e.y+(Math.random()-0.5)*60, forced);
            }
            enemies.splice(i,1);
            kills++; score += 280 * Math.pow(5, e.rarity.index);
            player.xp += 420 * Math.pow(5, e.rarity.index);
            if (enemies.length < 50) spawnEnemy();
        }
    }

    // loot magnet (keep â€“ you still collect dropped loot)
    for (let i=loots.length-1;i>=0;i--) {
        const l = loots[i];
        if (Math.hypot(l.x-player.x, l.y-player.y) < 175) collectLoot(i);
    }

    // NO FREE LOOT SPAWN

    // cleanup petals, health check same
    if (player.health <= 0) gameOver = true;
    if (enemies.length < 55) spawnEnemy();
}

function draw() {
    ctx.fillStyle = '#3a8c3a'; ctx.fillRect(0,0,W,H);
    // grid + walls same

    // LOOTS â€“ show rarity clearly
    for (let l of loots) {
        const sx = l.x - cameraX, sy = l.y - cameraY;
        drawPetal(sx, sy, Date.now()/300, l.typeKey, l.rarity, 0.7);
        // rarity letter
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(l.rarity.name[0], sx, sy + 12);
    }

    // ENEMIES + HEALTH BAR
    for (let e of enemies) {
        const sx = e.x - cameraX, sy = e.y - cameraY;
        ctx.shadowBlur = 35 * e.rarity.index; ctx.shadowColor = e.rarity.glow;
        ctx.fillStyle = e.col;
        ctx.beginPath(); ctx.arc(sx,sy,e.size,0,Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        // label
        ctx.fillStyle = e.rarity.glow;
        ctx.font = 'bold 14px Arial';
        ctx.fillText(e.id.toUpperCase() + " " + e.rarity.name, sx, sy - e.size - 22);

        // HEALTH BAR
        const barW = e.size * 2.2;
        ctx.fillStyle = '#00000099';
        ctx.fillRect(sx - barW/2, sy - e.size - 12, barW, 6);
        ctx.fillStyle = '#f44';
        ctx.fillRect(sx - barW/2, sy - e.size - 12, barW * (e.health / e.maxHealth), 6);
    }

    // PLAYER PETALS same
    // PLAYER same

    // MINI-MAP
    drawMiniMap();

    // UI same + zone

    if (gameOver) { /* same with preserved level/petals */ }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// canvas click, reset, loadProgress, START same as v6 but with new ENEMY_TYPES
loadProgress();
updatePlayerStats();
recalcBonuses();
for (let i=0;i<5;i++) player.petals.push({key:"basic", rarity:RARITIES[0], curDur:140});
for (let i=0;i<55;i++) spawnEnemy(); // start with many
loop();
</script>
</body>
</html>
