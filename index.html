<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PetalStorm.io – Real Florr Petals & Bugs</title>
    <style>
        body { margin:0; background:#111; font-family:Arial; color:#fff; text-align:center; overflow:hidden; }
        canvas { display:block; margin:20px auto; border:4px solid #333; box-shadow:0 0 30px #0f0; }
        #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); padding:12px; border-radius:10px; font-size:15px; }
        #petalsList { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); padding:8px; border-radius:8px; max-width:220px; font-size:13px; }
    </style>
</head>
<body>
    <canvas id="c" width="1000" height="700"></canvas>
    <div id="ui">
        Score: <span id="score">0</span> | Kills: <span id="kills">0</span><br>
        Health: <span id="health">300</span>/<span id="maxhealth">300</span>
    </div>
    <div id="petalsList"></div>
    <div id="instructions" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 20px;border-radius:8px;font-size:14px;">
        MOUSE = move • Kill bugs for huge loot • Real Florr petals with abilities!
    </div>

<script>
// ====================== PETALSTORM.IO v2 – Real Florr Petals & Bugs ======================
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 1000, H = 700;

let mouseX = W/2, mouseY = H/2;
canvas.addEventListener('mousemove', e => { const r=canvas.getBoundingClientRect(); mouseX=e.clientX-r.left; mouseY=e.clientY-r.top; });

const RARITIES = [
    {name:"Common", color:"#aaa", mult:1, chance:40},
    {name:"Uncommon", color:"#4f4", mult:1.9, chance:24},
    {name:"Rare", color:"#48f", mult:3.8, chance:15},
    {name:"Epic", color:"#a4f", mult:8, chance:9},
    {name:"Legendary", color:"#fa2", mult:16, chance:5.5},
    {name:"Mythic", color:"#f4c", mult:30, chance:3.5},
    {name:"Ultra", color:"#2ff", mult:55, chance:1.8},
    {name:"Super", color:"#ff4", mult:95, chance:0.9},
    {name:"Eternal", color:"#f55", mult:170, chance:0.4},
    {name:"Unique", color:"#4fa", mult:290, chance:0.2},
    {name:"Divine", color:"#fd7", mult:500, chance:0.08},
    {name:"Cosmic", color:"#7af", mult:880, chance:0.02}
];

function getRandomRarity() {
    let r = Math.random()*100, cum=0;
    for (let rar of RARITIES) { cum += rar.chance; if (r < cum) return rar; }
    return RARITIES[0];
}

// ==================== REAL FLORR PETALS (from official wiki) ====================
const PETAL_DEFS = {
    basic:  {name:"Basic",  col:"#ddd", dmg:1.0, dur:120, rot:1.0, special:"none"},
    rose:   {name:"Rose",   col:"#f68", dmg:0.4, dur:95,  rot:1.0, special:"heal", healRate:1.2},
    stinger:{name:"Stinger",col:"#fc4", dmg:4.8, dur:38,  rot:0.85, special:"poison", poison:1.8},
    cactus: {name:"Cactus", col:"#4b4", dmg:1.3, dur:210, rot:0.9,  special:"maxhp", bonus:42},
    leaf:   {name:"Leaf",   col:"#8f4", dmg:0.7, dur:130, rot:1.15, special:"heal", healRate:2.1},
    heavy:  {name:"Heavy",  col:"#777", dmg:4.2, dur:280, rot:0.55, special:"knock"},
    shell:  {name:"Shell",  col:"#9cf", dmg:1.1, dur:420, rot:1.0, special:"shield", shield:0.18},
    light:  {name:"Light",  col:"#ff8", dmg:0.75,dur:75,  rot:2.6, special:"none"}
};

let player = {
    x: 2000, y: 1500,
    health: 300, maxHealth: 300,
    speed: 4.3,
    angle: 0,
    petals: [],          // {key:"rose", rarityObj, curDur: 180}
    size: 26
};

let enemies = [], loots = [], projectiles = [], particles = [];
let score = 0, kills = 0, gameOver = false;
let lastLoot = 0;
let cameraX = 0, cameraY = 0;

// Enemy types with specific drop biases (real Florr style)
const ENEMY_TYPES = [
    {id:"ladybug", col:"#f66", size:19, hp:65, speed:1.3, dmg:0.7, drops:["rose","leaf","basic"], bias:[0.45,0.35,0.2]},
    {id:"bee",     col:"#ff4", size:17, hp:55, speed:2.1, dmg:1.1, drops:["stinger","light","basic"], bias:[0.6,0.25,0.15]},
    {id:"ant",     col:"#c93", size:18, hp:48, speed:1.6, dmg:0.8, drops:["basic","light","rose"], bias:[0.5,0.3,0.2]},
    {id:"beetle",  col:"#642", size:26, hp:140,speed:0.9, dmg:1.4, drops:["cactus","heavy","shell"], bias:[0.4,0.35,0.25]},
    {id:"hornet",  col:"#f82", size:22, hp:95, speed:1.8, dmg:1.2, drops:["stinger","light"], bias:[0.7,0.3]}
];

function spawnEnemy() {
    const type = ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
    const ang = Math.random()*Math.PI*2;
    const dist = 400 + Math.random()*600;
    enemies.push({
        ...type,
        x: player.x + Math.cos(ang)*dist,
        y: player.y + Math.sin(ang)*dist,
        health: type.hp,
        maxHealth: type.hp,
        poisonTime: 0,
        poisonDmg: 0
    });
}

function spawnLoot(x, y, forcedType = null) {
    const typeKey = forcedType || Object.keys(PETAL_DEFS)[Math.floor(Math.random()*Object.keys(PETAL_DEFS).length)];
    loots.push({x, y, typeKey, rarity: getRandomRarity()});
}

function collectLoot(i) {
    const l = loots[i];
    const def = PETAL_DEFS[l.typeKey];
    const newPetal = {
        key: l.typeKey,
        rarity: l.rarity,
        curDur: def.dur * l.rarity.mult * 1.1
    };

    if (player.petals.length < 8) {
        player.petals.push(newPetal);
    } else {
        // replace weakest
        let worst = 0;
        for (let j=1; j<player.petals.length; j++) {
            if (player.petals[j].rarity.mult < player.petals[worst].rarity.mult) worst = j;
        }
        if (newPetal.rarity.mult > player.petals[worst].rarity.mult) player.petals[worst] = newPetal;
    }
    loots.splice(i,1);
    score += Math.floor(l.rarity.mult * 15);
    recalcBonuses();
}

function recalcBonuses() {
    let extraHP = 0;
    for (let p of player.petals) {
        if (PETAL_DEFS[p.key].special === "maxhp") extraHP += PETAL_DEFS[p.key].bonus * p.rarity.mult;
    }
    player.maxHealth = 300 + extraHP;
    if (player.health > player.maxHealth) player.health = player.maxHealth;
}

// ==================== MAIN LOOP ====================
function update() {
    if (gameOver) return;

    // Player movement
    const dx = mouseX - W/2, dy = mouseY - H/2;
    const d = Math.hypot(dx,dy) || 1;
    if (d > 15) {
        player.x += (dx/d) * player.speed;
        player.y += (dy/d) * player.speed;
    }
    player.angle += 0.028;

    cameraX = player.x - W/2;
    cameraY = player.y - H/2;

    // Petal bonuses & healing
    let healThisFrame = 0;
    for (let p of player.petals) {
        const def = PETAL_DEFS[p.key];
        if (def.special === "heal") healThisFrame += def.healRate * p.rarity.mult * 0.016;
    }
    player.health += healThisFrame;
    if (player.health > player.maxHealth) player.health = player.maxHealth;

    // Enemies
    for (let i = enemies.length-1; i >= 0; i--) {
        const e = enemies[i];
        const edx = player.x - e.x, edy = player.y - e.y;
        const ed = Math.hypot(edx, edy) || 1;
        e.x += (edx/ed) * e.speed;
        e.y += (edy/ed) * e.speed;

        // Player touch damage
        if (ed < player.size + e.size) player.health -= e.dmg * 0.6;

        // Petal damage + special effects
        let totalDmg = 0;
        for (let j = 0; j < player.petals.length; j++) {
            const p = player.petals[j];
            const def = PETAL_DEFS[p.key];
            const ang = player.angle + (j/player.petals.length)*Math.PI*2;
            const px = player.x + Math.cos(ang)*48;
            const py = player.y + Math.sin(ang)*48;

            if (Math.hypot(px-e.x, py-e.y) < 24 + e.size) {
                const dmg = def.dmg * p.rarity.mult * 0.42;
                totalDmg += dmg;
                p.curDur -= 0.8; // enemies damage petals

                if (def.special === "poison") {
                    e.poisonTime = 90;
                    e.poisonDmg = def.poison * p.rarity.mult * 0.03;
                }
                if (def.special === "knock") {
                    e.x -= (edx/ed) * 9 * p.rarity.mult;
                    e.y -= (edy/ed) * 9 * p.rarity.mult;
                }
            }
        }
        e.health -= totalDmg;

        // Poison tick
        if (e.poisonTime > 0) {
            e.health -= e.poisonDmg;
            e.poisonTime--;
        }

        if (e.health <= 0) {
            // HIGH LOOT + type-specific drops
            const dropCount = 5 + Math.floor(Math.random()*8);
            for (let d=0; d<dropCount; d++) {
                const idx = Math.random() < 0.75 ? 
                    Math.floor(Math.random()*e.drops.length) : 
                    Math.floor(Math.random()*Object.keys(PETAL_DEFS).length);
                const forced = e.drops ? e.drops[idx] : null;
                spawnLoot(e.x + (Math.random()-0.5)*40, e.y + (Math.random()-0.5)*40, forced);
            }
            enemies.splice(i,1);
            kills++;
            score += 180;
            if (enemies.length < 28) spawnEnemy();
        }
    }

    // Loot magnet + collect
    for (let i=loots.length-1; i>=0; i--) {
        const l = loots[i];
        if (Math.hypot(l.x-player.x, l.y-player.y) < 55) collectLoot(i);
    }

    // Insane free loot (your request)
    if (Date.now() - lastLoot > 340) {
        for (let i=0; i<4; i++) spawnLoot(player.x + (Math.random()-0.5)*300, player.y + (Math.random()-0.5)*300);
        lastLoot = Date.now();
    }

    // Cleanup dead petals
    for (let i=player.petals.length-1; i>=0; i--) {
        if (player.petals[i].curDur <= 0) player.petals.splice(i,1);
    }

    if (player.health <= 0) gameOver = true;
    if (enemies.length < 22) spawnEnemy();
}

function draw() {
    ctx.fillStyle = '#3a8c3a';
    ctx.fillRect(0,0,W,H);

    // Grid
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    for (let x = -cameraX%70; x < W; x+=70) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for (let y = -cameraY%70; y < H; y+=70) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

    // Loots
    for (let l of loots) {
        const sx = l.x - cameraX, sy = l.y - cameraY;
        ctx.shadowBlur = 25; ctx.shadowColor = PETAL_DEFS[l.typeKey].col;
        ctx.fillStyle = l.rarity.color;
        ctx.beginPath(); ctx.arc(sx,sy,13,0,Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = "#fff"; ctx.font="bold 11px Arial"; ctx.textAlign="center";
        ctx.fillText(PETAL_DEFS[l.typeKey].name[0], sx, sy+4);
    }

    // Enemies
    for (let e of enemies) {
        const sx = e.x - cameraX, sy = e.y - cameraY;
        ctx.fillStyle = e.col;
        ctx.beginPath(); ctx.arc(sx,sy,e.size,0,Math.PI*2); ctx.fill();
        if (e.poisonTime > 0) {
            ctx.fillStyle = "rgba(0,255,80,0.4)";
            ctx.beginPath(); ctx.arc(sx,sy,e.size+4,0,Math.PI*2); ctx.fill();
        }
    }

    // Player petals
    for (let i=0; i<player.petals.length; i++) {
        const p = player.petals[i];
        const def = PETAL_DEFS[p.key];
        const ang = player.angle + (i/player.petals.length)*Math.PI*2 + (def.rot ? 0 : 0.3);
        const px = player.x + Math.cos(ang)*49 - cameraX;
        const py = player.y + Math.sin(ang)*49 - cameraY;

        ctx.save();
        ctx.translate(px,py);
        ctx.rotate(ang);

        ctx.fillStyle = def.col;
        ctx.shadowBlur = 15; ctx.shadowColor = def.col;
        ctx.fillRect(-18,-9,36,18); // different shapes possible later
        ctx.shadowBlur = 0;

        ctx.fillStyle = "#fff8"; ctx.fillRect(-13,-4,10,8);
        ctx.restore();

        // durability bar
        if (p.curDur < def.dur * p.rarity.mult * 0.9) {
            const ratio = p.curDur / (def.dur * p.rarity.mult * 1.1);
            ctx.fillStyle = "#00000088";
            ctx.fillRect(px-11, py-22, 22, 4);
            ctx.fillStyle = ratio > 0.4 ? "#4f4" : "#f44";
            ctx.fillRect(px-11, py-22, 22*ratio, 4);
        }
    }

    // Player core
    const cx = player.x - cameraX, cy = player.y - cameraY;
    ctx.fillStyle = "#ffeb3b";
    ctx.beginPath(); ctx.arc(cx,cy,player.size,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "#222"; ctx.lineWidth = 6; ctx.stroke();
    ctx.fillStyle = "#222"; ctx.beginPath(); ctx.arc(cx,cy,11,0,Math.PI*2); ctx.fill();

    // Health bar
    ctx.fillStyle = "#00000099"; ctx.fillRect(cx-45, cy-48, 90, 9);
    ctx.fillStyle = player.health > player.maxHealth*0.3 ? "#4f4" : "#f44";
    ctx.fillRect(cx-45, cy-48, 90 * (player.health/player.maxHealth), 9);

    // UI
    document.getElementById('score').textContent = Math.floor(score);
    document.getElementById('kills').textContent = kills;
    document.getElementById('health').textContent = Math.floor(player.health);
    document.getElementById('maxhealth').textContent = Math.floor(player.maxHealth);

    // Petals list UI
    let listHTML = "Petals:<br>";
    for (let p of player.petals) {
        listHTML += `<span style="color:${p.rarity.color}">${PETAL_DEFS[p.key].name} ${p.rarity.name[0]}</span><br>`;
    }
    document.getElementById('petalsList').innerHTML = listHTML;

    if (gameOver) {
        ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#f44"; ctx.font = "bold 72px Arial"; ctx.textAlign = "center";
        ctx.fillText("GAME OVER", W/2, H/2-30);
        ctx.fillStyle = "#fff"; ctx.font = "28px Arial";
        ctx.fillText(`Score ${Math.floor(score)} • Kills ${kills}`, W/2, H/2+40);
        ctx.fillText("Click to restart", W/2, H/2+90);
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

canvas.addEventListener('click', () => { if (gameOver) { 
    player.petals = []; player.health = 300; player.maxHealth = 300;
    enemies = []; loots = []; score=0; kills=0; gameOver=false;
    for (let i=0;i<5;i++) player.petals.push({key:"basic", rarity:RARITIES[0], curDur:120});
    for (let i=0;i<15;i++) spawnEnemy();
}});

// START
for (let i=0;i<5;i++) player.petals.push({key:"basic", rarity:RARITIES[0], curDur:120});
for (let i=0;i<20;i++) spawnEnemy();
for (let i=0;i<12;i++) spawnLoot(player.x + (Math.random()-0.5)*400, player.y + (Math.random()-0.5)*400);
loop();
</script>
</body>
</html>
