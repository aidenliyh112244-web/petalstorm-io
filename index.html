<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PetalStorm.io v9 â€“ Walls Everywhere + Inventory + Dynamic Spawn + True Orbit Extend</title>
    <style>
        body { margin:0; background:#111; font-family:Arial; color:#fff; overflow:hidden; }
        canvas { display:block; margin:20px auto; border:4px solid #333; box-shadow:0 0 40px #0f0; }
        #ui { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.75); padding:12px 16px; border-radius:10px; font-size:15px; line-height:1.35; }
        #petalsList { position:absolute; top:10px; right:220px; background:rgba(0,0,0,0.75); padding:10px; border-radius:8px; max-width:260px; font-size:13px; }
        #craftMenu, #inventoryMenu { display:none; position:absolute; bottom:20px; left:20px; background:rgba(15,25,35,0.97); padding:18px; border-radius:16px; border:6px solid #0ff; width:380px; text-align:left; box-shadow:0 0 60px #0ff; }
        #pediaMenu { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(15,25,35,0.97); padding:25px; border-radius:18px; border:6px solid #0ff; width:460px; text-align:center; box-shadow:0 0 60px #0ff; }
        button { background:#0f0; color:#000; font-weight:bold; padding:10px 20px; margin:6px 4px; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
        button:hover { background:#4f4; }
        #extendBtn { position:absolute; bottom:140px; right:20px; background:#0ff; color:#000; padding:18px 40px; font-size:22px; border-radius:50px; box-shadow:0 0 30px #0ff; }
    </style>
</head>
<body>
    <canvas id="c" width="1000" height="700"></canvas>
    <div id="ui">Score: <span id="score">0</span> | Kills: <span id="kills">0</span><br>
        Level <span id="level">1</span> XP <span id="xp">0</span>/<span id="nextxp">920</span><br>
        Health <span id="health">300</span>/<span id="maxhealth">300</span> Slots <span id="slots">5/5</span><br>
        Zone: <span id="zone">Normal</span>
    </div>
    <div id="petalsList"></div>
    <button id="extendBtn">EXTEND ORBIT (A)</button>

    <div id="craftMenu">
        <h2 style="color:#0ff;margin:0 0 12px 0">ðŸŒŸ CRAFTING LAB</h2>
        <div id="craftInfo" style="max-height:280px;overflow:auto;"></div>
        <button onclick="closeCraft()" style="background:#555;width:100%;margin-top:12px">Close (ESC)</button>
    </div>

    <div id="inventoryMenu">
        <h2 style="color:#0ff;margin:0 0 12px 0">ðŸ“¦ INVENTORY (40 slots)</h2>
        <div id="inventoryInfo" style="max-height:280px;overflow:auto;"></div>
        <button onclick="closeInventory()" style="background:#555;width:100%;margin-top:12px">Close (I)</button>
    </div>

    <div id="pediaMenu">
        <h2 style="color:#0ff">ðŸ“– PEDIA</h2>
        <div id="pediaContent" style="text-align:left;font-size:13px;line-height:1.5;max-height:420px;overflow:auto;"></div>
        <button onclick="closePedia()" style="background:#555">Close (H)</button>
    </div>

    <div id="instructions" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 20px;border-radius:8px;font-size:14px;">
        MOUSE = move â€¢ C = Craft â€¢ I = Inventory â€¢ A / EXTEND = Petals fly farther out â€¢ H = Pedia
    </div>

<script>
// ====================== PETALSTORM.IO v9 â€“ COMPLETE ======================
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 1000, H = 700;

let mouseX = W/2, mouseY = H/2;
canvas.addEventListener('mousemove', e => { const r=canvas.getBoundingClientRect(); mouseX=e.clientX-r.left; mouseY=e.clientY-r.top; });

let keys = {};
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key.toLowerCase() === 'a') toggleExtend();
    if (e.key === 'c' || e.key === 'C') toggleCraft();
    if (e.key === 'i' || e.key === 'I') toggleInventory();
    if (e.key === 'h' || e.key === 'H') togglePedia();
    if (e.key === 'Escape') { closeCraft(); closeInventory(); closePedia(); }
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

document.getElementById('extendBtn').addEventListener('click', toggleExtend);

const RARITIES = [ /* same as v8 */ 
    {name:"Common", color:"#aaa", mult:1, chance:40, index:0},{name:"Uncommon", color:"#4f4", mult:3, chance:24, index:1},
    {name:"Rare", color:"#48f", mult:9, chance:15, index:2},{name:"Epic", color:"#a4f", mult:27, chance:9, index:3},
    {name:"Legendary", color:"#fa2", mult:81, chance:5.5, index:4},{name:"Mythic", color:"#f4c", mult:243, chance:3.5, index:5},
    {name:"Ultra", color:"#2ff", mult:729, chance:1.8, index:6},{name:"Super", color:"#ff4", mult:2187, chance:0.9, index:7},
    {name:"Eternal", color:"#f55", mult:6561, chance:0.4, index:8},{name:"Unique", color:"#4fa", mult:19683, chance:0.2, index:9},
    {name:"Divine", color:"#fd7", mult:59049, chance:0.08, index:10},{name:"Cosmic", color:"#7af", mult:177147, chance:0.02, index:11}
];

function getRandomRarity() {
    let r = Math.random()*100, cum=0;
    for (let rar of RARITIES) { cum += rar.chance; if (r < cum) return rar; }
    return RARITIES[0];
}

const MOB_RARITIES = [
    {name:"Normal", mult:1, glow:"#fff", index:0},{name:"Rare", mult:5, glow:"#48f", index:1},
    {name:"Epic", mult:25, glow:"#a4f", index:2},{name:"Ultra", mult:125, glow:"#fa2", index:3},
    {name:"Nightmare", mult:625, glow:"#f4c", index:4}
];

function getRandomMobRarity(zoneIdx) {
    let target = Math.max(0, Math.min(4, zoneIdx + Math.floor(Math.random()*3)-1));
    return MOB_RARITIES.find(m => m.index === target) || MOB_RARITIES[0];
}

const PETAL_DEFS = {
    basic:  {name:"Basic",  col:"#ddd", dmg:1.0, dur:140, rot:1.0, special:"none"},
    rose:   {name:"Rose",   col:"#f68", dmg:0.35, dur:110, rot:1.0, special:"heal", healRate:1.8},
    stinger:{name:"Stinger",col:"#fc4", dmg:6.2, dur:42, rot:0.8, special:"poison", poison:2.4},
    cactus: {name:"Cactus", col:"#4b4", dmg:1.1, dur:280, rot:0.9, special:"maxhp", bonus:65},
    leaf:   {name:"Leaf",   col:"#8f4", dmg:0.6, dur:160, rot:1.2, special:"heal", healRate:3.1},
    heavy:  {name:"Heavy",  col:"#777", dmg:5.5, dur:310, rot:0.5, special:"knock"},
    shell:  {name:"Shell",  col:"#9cf", dmg:0.95, dur:480, rot:1.0, special:"shield", shield:0.22},
    light:  {name:"Light",  col:"#ff8", dmg:0.8, dur:68, rot:3.4, special:"none"}
};

let player = {x:2000,y:1500,health:300,maxHealth:300,speed:4.3,angle:0,petals:[],inventory:[],level:1,xp:0,xpToNext:920,maxSlots:5,bodyDamage:7,size:26};
let enemies = [], loots = [], walls = [], score = 0, kills = 0, gameOver = false;
let cameraX = 0, cameraY = 0;
let craftOpen = false, inventoryOpen = false, pediaOpen = false;
let petalRadius = 49;
let extendEndTime = 0;
const EXTEND_DURATION = 8000;
const EXTEND_COOLDOWN = 15000;
let lastExtend = 0;

const ENEMY_TYPES = [
    {id:"ladybug", col:"#f66", baseSize:19, baseHP:72, baseSpeed:1.1, baseDmg:0.8, drops:["rose","leaf","basic"]},
    {id:"bee",     col:"#ff4", baseSize:17, baseHP:58, baseSpeed:1.5, baseDmg:1.1, drops:["stinger","light","basic"]},
    {id:"ant",     col:"#c93", baseSize:18, baseHP:52, baseSpeed:1.3, baseDmg:0.9, drops:["basic","light","rose"]},
    {id:"beetle",  col:"#642", baseSize:26, baseHP:165,baseSpeed:0.8, baseDmg:1.5, drops:["cactus","heavy","shell"]},
    {id:"hornet",  col:"#f82", baseSize:22, baseHP:105,baseSpeed:1.4, baseDmg:1.3, drops:["stinger","light"]},
    {id:"rock",    col:"#888", baseSize:28, baseHP:220,baseSpeed:0.0, baseDmg:2.0, drops:["heavy","cactus"]},
    {id:"spider",  col:"#822", baseSize:21, baseHP:95, baseSpeed:2.4, baseDmg:1.4, drops:["stinger","light"]},
    {id:"scorpion",col:"#c60", baseSize:24, baseHP:130,baseSpeed:1.2, baseDmg:1.8, drops:["cactus","heavy"]},
    {id:"bumble",  col:"#fa4", baseSize:19, baseHP:80, baseSpeed:2.8, baseDmg:1.0, drops:["rose","light"]}
];

function generateWalls() {
    walls = [];
    for (let i = 0; i < 135; i++) {
        walls.push({
            x: Math.random() * 14000 - 5000,
            y: Math.random() * 14000 - 5000,
            w: 50 + Math.random() * 280,
            h: 50 + Math.random() * 280
        });
    }
}

function loadProgress() {
    const s = localStorage.getItem('petalStormSaveV9');
    if (s) {
        const d = JSON.parse(s);
        player.level = d.level||1; player.xp = d.xp||0; player.xpToNext = d.xpToNext||920;
        player.petals = d.petals||[]; player.inventory = d.inventory||[];
    }
}
function saveProgress() {
    localStorage.setItem('petalStormSaveV9', JSON.stringify({
        level:player.level, xp:player.xp, xpToNext:player.xpToNext, petals:player.petals, inventory:player.inventory
    }));
}

function updatePlayerStats() { /* same as before */ 
    player.maxSlots = Math.min(15, 5 + Math.floor((player.level-1)/10));
    player.maxHealth = 300 + (player.level-1)*28;
    player.bodyDamage = 4 + player.level*1.8;
}

function getZoneInfo() { /* same */ 
    const dist = Math.hypot(player.x-2000, player.y-1500);
    return Math.min(4, Math.max(0, Math.floor(dist / 1350)));
}

function spawnEnemy() { /* same as v8 */ 
    const type = ENEMY_TYPES[Math.floor(Math.random()*ENEMY_TYPES.length)];
    const zoneIdx = getZoneInfo();
    const mobR = getRandomMobRarity(zoneIdx);
    const ang = Math.random()*Math.PI*2;
    const dist = 480 + Math.random()*720;
    const hp = type.baseHP * 100 * Math.pow(5, mobR.index);
    const dmg = type.baseDmg * Math.pow(5, mobR.index);
    enemies.push({
        ...type, rarity: mobR,
        x: player.x + Math.cos(ang)*dist, y: player.y + Math.sin(ang)*dist,
        health: hp, maxHealth: hp,
        speed: type.baseSpeed * (1 + mobR.index*0.3),
        dmg: dmg,
        size: type.baseSize * (1 + mobR.index*0.25),
        poisonTime:0, poisonDmg:0
    });
}

function spawnLoot(x, y, forcedType = null) { /* same */ 
    const typeKey = forcedType || Object.keys(PETAL_DEFS)[Math.floor(Math.random()*Object.keys(PETAL_DEFS).length)];
    loots.push({x, y, typeKey, rarity: getRandomRarity()});
}

function collectLoot(i) {
    const l = loots[i];
    const def = PETAL_DEFS[l.typeKey];
    const newP = {key:l.typeKey, rarity:l.rarity, curDur: def.dur * l.rarity.mult * 1.15};
    if (player.petals.length < player.maxSlots) player.petals.push(newP);
    else if (player.inventory.length < 40) player.inventory.push(newP);
    loots.splice(i,1);
    score += Math.floor(l.rarity.mult * 22);
    player.xp += Math.floor(55 * l.rarity.mult);
    recalcBonuses();
}

function recalcBonuses() { /* same */ 
    let extra = 0;
    for (let p of player.petals) if (PETAL_DEFS[p.key].special === "maxhp") extra += PETAL_DEFS[p.key].bonus * p.rarity.mult * 4;
    player.maxHealth = 300 + (player.level-1)*28 + extra;
}

// ====================== DRAW PETAL (with dynamic radius) ======================
function drawPetal(px, py, ang, key, rarity, scale = 1) {
    const def = PETAL_DEFS[key];
    ctx.save();
    ctx.translate(px, py);
    ctx.rotate(ang + (def.rot||1));
    ctx.fillStyle = def.col;
    ctx.shadowBlur = 20 * scale;
    ctx.shadowColor = rarity.color;
    const s = 22 * scale;

    if (key === "rose") { for(let i=0;i<5;i++){ctx.rotate(Math.PI*2/5); ctx.beginPath(); ctx.ellipse(0,-s*0.6, s*0.4, s*0.9,0,0,Math.PI*2); ctx.fill();} ctx.fillStyle="#fff"; ctx.beginPath();ctx.arc(0,0,s*0.35,0,Math.PI*2);ctx.fill(); }
    else if (key === "stinger") { ctx.beginPath(); ctx.moveTo(0,-s); ctx.lineTo(-s*0.45, s*0.7); ctx.lineTo(s*0.45, s*0.7); ctx.closePath(); ctx.fill(); ctx.fillStyle="#000"; ctx.beginPath();ctx.arc(0,-s*0.55, s*0.22,0,Math.PI*2);ctx.fill(); }
    else if (key === "cactus") { ctx.fillRect(-s*0.45, -s, s*0.9, s*2); ctx.fillStyle="#000"; ctx.fillRect(-s*0.65,-s*0.4,s*0.25,s*0.22); ctx.fillRect(s*0.4,-s*0.4,s*0.25,s*0.22); ctx.fillRect(-s*0.65,s*0.3,s*0.25,s*0.22); ctx.fillRect(s*0.4,s*0.3,s*0.25,s*0.22); }
    else if (key === "leaf") { ctx.beginPath(); ctx.moveTo(0,-s); ctx.bezierCurveTo(-s*0.7,-s*0.4,-s*0.9,s*0.4,0,s*0.85); ctx.bezierCurveTo(s*0.9,s*0.4,s*0.7,-s*0.4,0,-s); ctx.fill(); ctx.fillStyle="#000"; ctx.fillRect(-s*0.1,-s,s*0.2,s*2); }
    else if (key === "heavy") { ctx.fillRect(-s*1.05, -s*0.6, s*2.1, s*1.2); ctx.fillStyle="#fff9"; ctx.fillRect(-s*0.75,-s*0.45,s*1.5,s*0.3); }
    else if (key === "shell") { ctx.beginPath(); ctx.arc(0,0,s*0.95,Math.PI*0.5,Math.PI*2.5); ctx.fill(); ctx.fillStyle="#000"; ctx.fillRect(-s*0.95,-s*0.2,s*0.55,s*0.4); }
    else if (key === "light") { ctx.rotate(Date.now()/90); ctx.fillRect(-s*0.2,-s,s*0.4,s*2); ctx.fillRect(-s,-s*0.2,s*2,s*0.4); }
    else { ctx.fillRect(-s*0.65,-s*0.65,s*1.3,s*1.3); }

    ctx.shadowBlur = 0;
    ctx.restore();
}

function toggleExtend() {
    const now = Date.now();
    if (now - lastExtend < EXTEND_COOLDOWN) return;
    petalRadius = 85;
    extendEndTime = now + EXTEND_DURATION;
    lastExtend = now;
}

// ====================== INVENTORY ======================
function updateInventoryUI() {
    let html = `<b>Equipped (${player.petals.length}/${player.maxSlots})</b><br>`;
    player.petals.forEach((p,i) => {
        html += `<span style="color:${p.rarity.color}">${PETAL_DEFS[p.key].name} ${p.rarity.name[0]}</span> <button onclick="unequip(${i});updateInventoryUI()">â†’ Inv</button><br>`;
    });
    html += `<br><b>Inventory (${player.inventory.length}/40)</b><br>`;
    player.inventory.forEach((p,i) => {
        html += `<span style="color:${p.rarity.color}">${PETAL_DEFS[p.key].name} ${p.rarity.name[0]}</span> <button onclick="equipFromInv(${i});updateInventoryUI()">â†’ Equip</button><br>`;
    });
    document.getElementById('inventoryInfo').innerHTML = html || "Empty";
}

function unequip(idx) {
    if (player.inventory.length >= 40) return;
    player.inventory.push(player.petals[idx]);
    player.petals.splice(idx,1);
    recalcBonuses();
}

function equipFromInv(idx) {
    if (player.petals.length >= player.maxSlots) return;
    player.petals.push(player.inventory[idx]);
    player.inventory.splice(idx,1);
    recalcBonuses();
}

function toggleInventory() {
    inventoryOpen = !inventoryOpen;
    document.getElementById('inventoryMenu').style.display = inventoryOpen ? 'block' : 'none';
    if (inventoryOpen) updateInventoryUI();
}
function closeInventory() { inventoryOpen=false; document.getElementById('inventoryMenu').style.display='none'; }

// ====================== CRAFTING (same) ======================
function updateCraftUI() { /* same as v8 */ 
    let html = "";
    let groups = {};
    player.petals.forEach(p => {
        const id = p.key + "|" + p.rarity.name;
        if (!groups[id]) groups[id] = {key:p.key, rarity:p.rarity, count:0};
        groups[id].count++;
    });
    for (let g in groups) {
        const gr = groups[g];
        if (gr.count >= 5 && gr.rarity.index < 11) {
            html += `<div class="group"><b style="color:${gr.rarity.color}">${PETAL_DEFS[gr.key].name} ${gr.rarity.name}</b> Ã—${gr.count}<br>
                <button onclick="attemptCraft('${gr.key}',${JSON.stringify(gr.rarity).replace(/"/g,'&quot;')});updateCraftUI()">Craft 1Ã—</button>
                <button onclick="bulkCraft('${gr.key}',${JSON.stringify(gr.rarity).replace(/"/g,'&quot;')});">FAST ALL</button></div>`;
        }
    }
    document.getElementById('craftInfo').innerHTML = html || "Need 5+ identical";
}
function attemptCraft(key, rarityObj) { /* same */ 
    const rIdx = rarityObj.index;
    const chance = [0.64,0.32,0.16,0.08,0.04,0.02,0.01,0.001][rIdx] || 0.001;
    let count = player.petals.filter(p => p.key===key && p.rarity.name===rarityObj.name).length;
    if (count < 5) return;
    let removed = 0;
    for (let i=player.petals.length-1; i>=0 && removed<5; i--) {
        if (player.petals[i].key===key && player.petals[i].rarity.name===rarityObj.name) { player.petals.splice(i,1); removed++; }
    }
    if (Math.random() < chance) {
        const nextR = RARITIES[Math.min(rIdx+1, RARITIES.length-1)];
        const def = PETAL_DEFS[key];
        player.petals.push({key:key, rarity:nextR, curDur:def.dur * nextR.mult * 1.3});
        score += 680;
    } else {
        const keep = 1 + Math.floor(Math.random()*4);
        for (let i=0; i<keep; i++) player.petals.push({key:key, rarity:rarityObj, curDur:PETAL_DEFS[key].dur * rarityObj.mult * 1.1});
    }
    recalcBonuses();
}
function bulkCraft(key, rarityObj) {
    let crafted = 0;
    while (player.petals.filter(p => p.key===key && p.rarity.name===rarityObj.name).length >= 5 && crafted < 15) {
        attemptCraft(key, rarityObj);
        crafted++;
    }
    updateCraftUI();
}
function toggleCraft() { craftOpen = !craftOpen; document.getElementById('craftMenu').style.display = craftOpen ? 'block' : 'none'; if (craftOpen) updateCraftUI(); }
function closeCraft() { craftOpen=false; document.getElementById('craftMenu').style.display='none'; }

function togglePedia() { pediaOpen = !pediaOpen; document.getElementById('pediaMenu').style.display = pediaOpen ? 'block' : 'none'; }
function closePedia() { pediaOpen=false; document.getElementById('pediaMenu').style.display='none'; }

function collides(x, y, size, wall) {
    return !(x + size < wall.x || x - size > wall.x + wall.w || y + size < wall.y || y - size > wall.y + wall.h);
}

function moveWithWalls(obj, dx, dy, size) {
    let nx = obj.x + dx, ny = obj.y + dy;
    for (let w of walls) if (collides(nx, ny, size, w)) return;
    obj.x = nx; obj.y = ny;
}

function drawMiniMap() {
    const mx = W - 210, my = 20, ms = 190;
    const sc = ms / 16000;
    ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(mx, my, ms, ms);
    ctx.strokeStyle = '#555'; ctx.strokeRect(mx, my, ms, ms);

    const px = mx + (player.x + 8000) * sc;
    const py = my + (player.y + 8000) * sc;
    ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = '#777';
    for (let w of walls) {
        ctx.fillRect(mx + (w.x + 8000)*sc, my + (w.y + 8000)*sc, w.w*sc, w.h*sc);
    }

    for (let e of enemies) {
        const ex = mx + (e.x + 8000) * sc;
        const ey = my + (e.y + 8000) * sc;
        ctx.fillStyle = e.rarity.glow;
        ctx.beginPath(); ctx.arc(ex, ey, 3, 0, Math.PI*2); ctx.fill();
    }
}

function respawn() {
    saveProgress();
    player.health = player.maxHealth;
    player.x = 2000; player.y = 1500;
    enemies = []; loots = [];
    score=0; kills=0; gameOver=false;
    for (let i=0;i<55;i++) spawnEnemy();
}

function resetGame() {
    player.petals = []; player.inventory = [];
    for (let i=0;i<5;i++) player.petals.push({key:"basic", rarity:RARITIES[0], curDur:140});
    player.level=1; player.xp=0; player.xpToNext=920;
    updatePlayerStats(); recalcBonuses();
    respawn();
}

function update() {
    if (gameOver) return;

    const dx = mouseX - W/2, dy = mouseY - H/2;
    const d = Math.hypot(dx,dy)||1;
    if (d > 12) {
        const moveSpeed = player.speed * 0.016 * 60;
        moveWithWalls(player, (dx/d)*moveSpeed, (dy/d)*moveSpeed, player.size);
    }
    player.angle += 0.028;
    cameraX = player.x - W/2; cameraY = player.y - H/2;

    if (Date.now() > extendEndTime) petalRadius = 49;

    // HEALING + LEVEL
    let heal = 0;
    for (let p of player.petals) if (PETAL_DEFS[p.key].special==="heal") heal += PETAL_DEFS[p.key].healRate * p.rarity.mult * 0.022;
    player.health += heal;
    while (player.xp >= player.xpToNext) { player.xp -= player.xpToNext; player.level++; player.xpToNext = Math.floor(player.xpToNext * 1.38 + 300); updatePlayerStats(); player.health += 140; }

    // DYNAMIC SPAWN
    let nearby = 0;
    for (let e of enemies) if (Math.hypot(e.x-player.x, e.y-player.y) < 900) nearby++;
    if (nearby < 18) for (let i=0; i<6; i++) spawnEnemy();

    // ENEMIES
    for (let i=enemies.length-1; i>=0; i--) {
        const e = enemies[i];
        const edx = player.x - e.x, edy = player.y - e.y;
        const ed = Math.hypot(edx,edy)||1;
        const move = e.speed * 0.016 * 60;
        moveWithWalls(e, (edx/ed)*move, (edy/ed)*move, e.size);

        if (ed < player.size + e.size + 8) { e.health -= player.bodyDamage * 0.6; player.health -= e.dmg * 0.5; }

        let totalDmg = 0;
        for (let j=0; j<player.petals.length; j++) {
            const p = player.petals[j];
            const def = PETAL_DEFS[p.key];
            const pang = player.angle + (j/player.petals.length)*Math.PI*2;
            const px = player.x + Math.cos(pang)*petalRadius;
            const py = player.y + Math.sin(pang)*petalRadius;
            if (Math.hypot(px-e.x, py-e.y) < 28) {
                totalDmg += def.dmg * Math.pow(p.rarity.mult, 3) * 0.5;
                p.curDur -= 0.95;
                if (def.special==="poison") { e.poisonTime=120; e.poisonDmg = def.poison * Math.pow(p.rarity.mult,1.3)*0.04; }
                if (def.special==="knock") { e.x -= (edx/ed)*18*p.rarity.mult; e.y -= (edy/ed)*18*p.rarity.mult; }
            }
        }
        e.health -= totalDmg;
        if (e.poisonTime>0) { e.health -= e.poisonDmg; e.poisonTime--; }

        if (e.health <= 0) {
            const dropCount = 8 + Math.floor(Math.random()*13) * (1 + e.rarity.index*2);
            for (let d=0; d<dropCount; d++) {
                const forced = Math.random()<0.82 ? e.drops[Math.floor(Math.random()*e.drops.length)] : null;
                spawnLoot(e.x+(Math.random()-0.5)*60, e.y+(Math.random()-0.5)*60, forced);
            }
            enemies.splice(i,1);
            kills++; score += 280 * Math.pow(5, e.rarity.index);
            player.xp += 420 * Math.pow(5, e.rarity.index);
            if (enemies.length < 55) spawnEnemy();
        }
    }

    for (let i=loots.length-1;i>=0;i--) {
        const l = loots[i];
        if (Math.hypot(l.x-player.x, l.y-player.y) < 175) collectLoot(i);
    }

    for (let i=player.petals.length-1;i>=0;i--) if (player.petals[i].curDur <= 0) player.petals.splice(i,1);

    if (player.health <= 0) gameOver = true;
}

function draw() {
    const zone = getZoneInfo();
    const biomeColors = ['#3a8c3a','#3a8c8c','#6c3a8c','#8c3a5a','#2a2a6c'];
    ctx.fillStyle = biomeColors[zone];
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    for (let x=-cameraX%70;x<W;x+=70){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for (let y=-cameraY%70;y<H;y+=70){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

    ctx.fillStyle = "#555";
    for (let w of walls) ctx.fillRect(w.x - cameraX, w.y - cameraY, w.w, w.h);

    for (let l of loots) {
        const sx = l.x - cameraX, sy = l.y - cameraY;
        drawPetal(sx, sy, Date.now()/300, l.typeKey, l.rarity, 0.7);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
        ctx.fillText(l.rarity.name[0], sx, sy + 12);
    }

    for (let e of enemies) {
        const sx = e.x - cameraX, sy = e.y - cameraY;
        ctx.shadowBlur = 35 * e.rarity.index; ctx.shadowColor = e.rarity.glow;
        ctx.fillStyle = e.col;
        ctx.beginPath(); ctx.arc(sx,sy,e.size,0,Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = e.rarity.glow;
        ctx.font = 'bold 14px Arial';
        ctx.fillText(e.id.toUpperCase() + " " + e.rarity.name, sx, sy - e.size - 22);

        const barW = e.size * 2.2;
        ctx.fillStyle = '#00000099'; ctx.fillRect(sx - barW/2, sy - e.size - 12, barW, 6);
        ctx.fillStyle = '#f44'; ctx.fillRect(sx - barW/2, sy - e.size - 12, barW * (e.health / e.maxHealth), 6);
    }

    for (let i=0; i<player.petals.length; i++) {
        const p = player.petals[i];
        const ang = player.angle + (i/player.petals.length)*Math.PI*2;
        const px = player.x + Math.cos(ang)*petalRadius - cameraX;
        const py = player.y + Math.sin(ang)*petalRadius - cameraY;
        drawPetal(px, py, ang, p.key, p.rarity, 1);
        if (p.curDur < PETAL_DEFS[p.key].dur * p.rarity.mult * 0.85) {
            const ratio = p.curDur / (PETAL_DEFS[p.key].dur * p.rarity.mult * 1.1);
            ctx.fillStyle = "#0009"; ctx.fillRect(px-14,py-28,28,5);
            ctx.fillStyle = ratio>0.4?"#4f4":"#f44"; ctx.fillRect(px-14,py-28,28*ratio,5);
        }
    }

    const cx = player.x - cameraX, cy = player.y - cameraY;
    ctx.fillStyle = "#ffeb3b"; ctx.beginPath(); ctx.arc(cx,cy,player.size,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "#222"; ctx.lineWidth=7; ctx.stroke();
    ctx.fillStyle="#222"; ctx.beginPath(); ctx.arc(cx,cy,11,0,Math.PI*2); ctx.fill();

    ctx.fillStyle="#000a"; ctx.fillRect(cx-52,cy-56,104,12);
    ctx.fillStyle = player.health > player.maxHealth*0.3 ? "#4f4" : "#f44";
    ctx.fillRect(cx-52,cy-56,104*(player.health/player.maxHealth),12);

    drawMiniMap();

    document.getElementById('score').textContent = Math.floor(score);
    document.getElementById('kills').textContent = kills;
    document.getElementById('level').textContent = player.level;
    document.getElementById('xp').textContent = Math.floor(player.xp);
    document.getElementById('nextxp').textContent = Math.floor(player.xpToNext);
    document.getElementById('health').textContent = Math.floor(player.health);
    document.getElementById('maxhealth').textContent = Math.floor(player.maxHealth);
    document.getElementById('slots').textContent = player.petals.length + "/" + player.maxSlots;
    document.getElementById('zone').textContent = MOB_RARITIES[getZoneInfo()].name;

    let list = `Petals (${player.petals.length}/${player.maxSlots})<br>`;
    player.petals.forEach(p => list += `<span style="color:${p.rarity.color}">${PETAL_DEFS[p.key].name} ${p.rarity.name[0]}</span><br>`);
    document.getElementById('petalsList').innerHTML = list;

    if (gameOver) {
        ctx.fillStyle = "rgba(0,0,0,0.9)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#f44"; ctx.font = "bold 78px Arial"; ctx.textAlign="center";
        ctx.fillText("YOU DIED", W/2, H/2-40);
        ctx.fillStyle = "#fff"; ctx.font = "28px Arial";
        ctx.fillText(`Level ${player.level} & petals SAVED`, W/2, H/2+35);
        ctx.fillText("Click to respawn", W/2, H/2+80);
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

canvas.addEventListener('click', () => { if (gameOver) respawn(); });

// START
generateWalls();
loadProgress();
updatePlayerStats();
recalcBonuses();
for (let i=0;i<5;i++) player.petals.push({key:"basic", rarity:RARITIES[0], curDur:140});
respawn();
loop();
</script>
</body>
</html>
